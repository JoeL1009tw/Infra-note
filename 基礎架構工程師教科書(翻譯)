# 基礎架構工程師教科書
翻譯此書的讀書心得整理
這本書是由LINE出版的。

## chapter01 基礎架構工程師的工作

### 01 基礎架構工程師的工作

#### 基礎架構設計

* 需求
  * 實現基礎架構的目的所需的功能和性能
  * 基於需求制定計劃書和設計書
    * 費用估算
    * 時間估算

#### 基礎架構的建置工作

* 細分類如下…
  * 設備運輸、設備組裝、設備安裝、設備安裝和設置、操作測試、負載測試
* 在SI業界中…
  * CE（客戶工程師）
    * 負責設備的運輸和安裝等硬體相關工作
  * SE（系統工程師）
    * 負責伺服器和存儲設備的設置
  * NE（網路工程師）
    * 負責網路設備的設置
* 在Web業界中…
  * 基礎架構工程師一手擔任全部工作

#### 基礎架構的維護運用

* 24小時全年365日
* 可以外包給MSP業者託管
  * MSP,Managed Service Provider/託管服務提供者
* 故障排除
  * 硬體的故障排除
  * 訪問突然激增的對策
* 承載量管理
  * 基礎架構環境建設完成後，隨著時間推移來增減訪問數及資料大小
  * 定期審查承載量，並根據需要增加
* 區分不是由基礎設施引起的原因

### 02 構成IT基礎設施的要素

* 設施
  * 資料中心及其機架、空調等設備
* 伺服器和存儲設備
* 網路

### 03 基礎架構工程師作為技術人員的各方面

* 伺服器/硬體
  * IA伺服器
  * 企業伺服器
* 伺服器OS
  * Linux, Windows, UNIX
* 存儲設備
  * 伴隨著快閃記憶體的興起而高速化
  * 資料量爆發式的增加背景
    * 存儲設備虛擬化
    * 服務開通/提供(Provisioning)
    * 去重複性（De-dupulication）
    * 快照/複寫(Snapshot)
* 網路
  * 因為無法直接看出問題，很難直接確定原因
  * 需要在設計階段從各個角度進行問題的排查，藉此排除問題區域。
* 網路設備
  * 需要長期留意的項目
    * 連接伺服器
    * 網路設備的數量
    * 接頭的區別標示
    * 通訊費用
    * 通訊速度
    * 路由器/L2交換機/L3交換機/L4交換機/L7交換機
    * 供應商/廠商
      * 指令因系統體系不同的差異

### 04 基礎架構工程師作為選擇者的各方面

正確的作法因計畫的性質與企業文化，或是決策者的考量而定

* 系統配置
* 選擇伺服器的規格
  * CPU, 記憶體, 硬碟, RAID, NIC, 電源供應器及冗餘的必要性(Regundancy), 維護年限及維護級別,延展性,物理尺寸,重量
* 網路配置
  * 每個機櫃中需配置幾個交換機
  * 每台交換機的應有多少承載量
  * 採納的廠商
  * 維護年限
  * 各網路・接口的通訊費用冗餘的必要性
* 資料庫的設計
  * RDBMS的選擇
    * Oracle, SQL Server, MySQL, PostgreSQL
  * 所需容量的計算
  * 決定資料庫綱要(schema)及物理上的資料配置
* 結構管理
  * 檢查討論監控及操作的方法

#### 公司內部的職責

* 開發者的職責
  * 應用程式〜中介軟體(Application〜Middleware)
* 伺服器工程師的職責
  * 中介軟體〜硬體(Middleware〜Hardware)的連接
* 網路工程師的職責
  * 網路交換機〜硬體(NetworkSwitch〜Hardware)的連接

## chapter 02 伺服器

### 05 伺服器的種類

* 機架式伺服器
  * 設置在資料中心(IDC)或公司內部機房的機架中
  * 以能設置在19英寸機架中為前提
  * 大小以1U, 2U等特有單位來決定
    * 1U的高度為1.75英吋
    * 入門型伺服器(low-end server)通常為1U的大小居多
    * 中端伺服器以上的規格，因為能搭載組件較多通常為2U或以上的大小居多
* 塔式伺服器
  * 除了設置於機房內，也可能會設置於辦公室或店鋪中
* 選定設置場所，因為伺服器必須克服散熱和噪音的問題
  * 將伺服器設置在密閉及有空調的專用空間，如資料中心或是公司內機房的話，通常不會有問題
  * 像是辦公室或店舖那樣人多的空間的話，可選擇塔型伺服器也可因應場合選擇**靜音伺服器**
* 伺服器通常有幾公斤到數十公斤的重量，請注意地板的耐久性

#### 依用途選擇合適的伺服器
* 入門級伺服器(Low-End Server)
  * 數十萬日圓
  * 可用於Web伺服器(Web Server)及應用程式伺服器(Application Server)
  * 每個插座單位可安裝1〜2個CPU
* 中端伺服器(Middle Range Server)
  * 數百萬日圓
  * 可用於資料庫伺服器(DetaBase Server)及企業伺服器(Core,Enterprise,Backbone)
  * 每個插座單位可安裝4個以上的CPU
* 高端伺服器(High-End Server)
  * 數千萬〜數億日圓
  * 可用於資料庫伺服器(DetaBase Server)及企業伺服器(Core,Enterprise,Backbone)
  * 每個插座單位可安裝10個以上的CPU

#### IA伺服器

* 配備 Intel 或 AMD 等 Intel兼容CPU
* 基於與一般個人電腦相同的體系架構製造
* 基本上選擇哪個廠牌架構都相同
* 由於廠牌和型號的不同，形式和功能存在一些差異，因此有必要檢查以下要素
  * 伺服器是否能確實安裝於資料中心的機架上
  * 可安裝的零件的件數
  * 故障發生時的支援體系
  * 是否支援遠端操縱
    * 依不同廠牌有不同的名稱及功能
  * 保固期限

#### 企業級伺服器

* 利用於企業系統
* 不同於IA伺服器的高價
* 首次的採購沒有一定的標準
  * 因此，通常會有廠商的營運SE前來做技術說明
* 在硬體發生警告時自動通知廠商，特別是重要度較高的企業級伺服器
  * 因此，也有連接電話線於伺服器上的服務
  * 這樣的情況，即使沒有通知，廠商也會自動的安排維修計畫

#### 伺服器與電腦的區別

* 因用途不同，設計理念也不一樣
  * 以一年365日24小時運行為前提
    * 硬體的故障率較低
    * 即使發生故障也極力避免系統停下的設計
    * 零組件的品質較高
    * 主要的組件有冗餘的設計考量，即使組件發生了故障，也可在不停止服務的狀況下更換組件
  * 故障發生時能獲得廠商廣泛的支援
  * 比起電腦，伺服器擁有較多的記憶體及HDD的支援可能性
  * 原則上，伺服器會安裝好伺服器用OS
  * 不推薦安裝廠商能夠保證用於伺服器上的OS以外的OS

### 06 伺服器的選擇

伺服器的選擇重點，盡量減少在選擇上的分歧，藉此縮小範圍

#### 伺服器的條件

* CPU
  * 頻率、數量(插座數)、核心數、快取記憶體容量、對虛擬化的支援 ...等
* 記憶體
  * 容量大小、傳輸速率、記憶體顆粒數 ...等
* 硬碟
  * 容量大小、硬碟轉速、HDD或SSD的採用 ...等
* RAID
  * RAID模式 1/5/6/10/50/60 ...等
* NIC
  * 網路介面卡須留意 2port, 4port, 8port ...等
* PSU
  * 電源供應器須留意 總瓦特、非冗餘(無不斷電)、冗餘(有不斷電)之功能 ...等
* 維護年限
  * 例 1年、3年、5年 ...等
* 維護等級
  * 例 4小時現地維護、平日至下個營業日、24小時365日全年對應 ...等
* 擴充性
  * 記憶體插槽數、PCI插槽數、可掛載硬碟數 ...等
* 物理尺寸大小
  * 1U, 2U, 4U ...等
* 重量
  * 輕量、超重重量 ...等

#### 如何決定伺服器的規格

* 實驗性的去建構實際的環境、根據測量結果判斷
  * 在系統核心中通常最能發揮作用的系統通常為核心系統或重要的系統
  * 需要大量的時間跟精力去做準備
* 將暫定的伺服器規格實際投入測試，依照實際的硬體規格實測後的狀況來決定伺服器及其他組件的增減
  * 例如線上遊戲的狀況，在還沒實際發布之前是無法判斷實際訪問量(無法事先預測結果)
  * 設備的數量充足的話，可以提前先投入多一點的設備，之後再依調整比例去調整規格
  * 如現有設備不足的狀況可與廠商接洽協商，在確定規格的情況下，廠商可能會臨時借出設備
* 透過消去法來縮小規格範圍
  * 在某種情況上指定了特定的支援性質
  * 例）
    * Web伺服器的情況，通常除了記憶體以外不會用到太多硬體資源，就可選用支援較多記憶體而其他功能達最低限度的伺服器規格

#### Scale out及Scale up

* Scale out
  * 在性能不足的狀況下，透過增加伺服器數量增加性能，藉此使產能提升的方法
  * 常用於分配負載量較容易的Web伺服器一樣的便宜機器，在性能不足時就可以透過增加數量獲得提升
* Scale up
  * 在性能不足的狀況下，透過增加記憶體或是組件的追加、更換
  * 常用於分配負載量較困難的資料庫伺服器

#### 廠商(供應商)之選擇

在日本國內可利用伺服器服務的主要廠商

* DELL PowerEdge系列
* NEC Express5800系列
* 日本HP ProLiant系列、Integrity系列
* 日本IBM x系列、PowerSystems系列 等
* 日本オラクルSPAEC系列、Sun Server系列
* 日本ユニシスES7000系列
* 日立製作所HA8000系列
* 富士通PRIMERGY系列、PRIMQUEST系列 等

### 07 CPU

* 直到現在，CPU 都在朝著如何在提高性能的同時減少發熱和功耗的方向發展
* 最近為了追求更好的性能，透過提高工作頻率獲得了性能上的提升，但也大大的伴隨著電力消費的缺點增加
  * 透過降低工作頻率到一定程度，藉此轉而使用多核多線程的等技術

#### CPU用語

* 插座數
  * 物理上CPU的程載數
* 工作頻率
  * CPU頻率，就是CPU的時脈頻率，簡單說是CPU運算時的工作的頻率（1秒內發生的同步脈衝數）的簡稱。單位是Hz
  * 工作頻率越高處理速度越快，也因電力使用效率差，伴隨發熱增加
* 核心
  * CPU的主要運算迴路
  * 1個CPU中含有複數個內核的多核CPU，複數個核心可以同時進行運算
* 快取記憶體
  * CPU與主記憶體之間，準備了快取記憶體這樣的緩存用高速記憶體
  * 透過存放頻繁的訪問的數據資料來實現高速化
* 超執行緒(Hyper-Threading / HT)
  * 使一個內核在OS上看起來像兩個 CPU 的技術（interl 的 CPU 術語）
  * 由於核心數沒有增加，所以CPU上的計算都是一個一個進行的
  * 減少OS端的負載，提速百分之幾十
* 渦輪加速技術(Intel® Turbo Boost )
  * CPU自動讓其執行速度超過額定作業頻率（interl 的 CPU 術語）
  * 有閒置沒工作的內核時，透過增加時脈讓它動起來

#### CPU選擇的要點

* 性能
  * 資料庫及應用程式伺服器等，那些對於CPU的佔用率較高的軟體需要較高的運算能力
  * 對於不會發生CPU負載的Web伺服器的狀況，也就不需要太高的運算能力
  * 高性能CPU不僅比普通CPU有更高的運算速度，還能做到同一時間進行多個複數的運算
    * 在同樣運算量的狀況下，高性能CPU比起普通CPU的CPU使用率還要來的少
* 核心數
  * 虛擬化的環境通常是在一台的伺服器上運行複數個客用的OS，因此選擇核心數多的CPU較為合適
  * 像是批處理程序這樣的單進程程式軟體，既使CPU使用率再高也只用到一個核心，換成核心數多的CPU也沒有意義
* 插座數
  * 有核心數相同性能卻不相同的情況
    * 1個8核心的CPU插座
    * 2個4核心的CPU插座
      * → 同樣是8核心但有著性能的差異
    * 原因為NUMA(Non-Uniform Memory Access)
      * 共有記憶體的多處理器電腦系統
      * 每個插座都有一個叫做MUMA node的單元，並個別搭載了自己的物理記憶體。
      * 從每個CPU都可以訪問全部安裝於伺服器的記憶體，無論從哪個節點位置
      * CPU對於同一節點的內存記憶體可以高速訪問
      * 對於訪問在其他節點上的內存記憶體的速度稍慢
    * 一般來說核心數較多的CPU較為高價，用普通的CPU安裝於多個插槽藉以增加核心數量是一個符合現實考量的選擇






